const axios = require("axios");
const cheerio = require("cheerio");
const path = require("path");
const fs = require("fs");
const pLimit = require("p-limit");

const limitFn = pLimit(2);

// 一系列網址
const urls = [
  "https://nhentai.net/g/528413",
  "https://nhentai.net/g/528234",
  "https://nhentai.net/g/509852",
  "https://nhentai.net/g/528235",
  "https://nhentai.net/g/528488",
  "https://nhentai.net/g/528457",
  "https://nhentai.net/g/528154",
  "https://nhentai.net/g/528054",
  "https://nhentai.net/g/527840",
  "https://nhentai.net/g/527909",
  "https://nhentai.net/g/527964",
  "https://nhentai.net/g/527963",
  "https://nhentai.net/g/525836",
  "https://nhentai.net/g/525442",
  "https://nhentai.net/g/527785",
  "https://nhentai.net/g/527752",
  "https://nhentai.net/g/375457",
  "https://nhentai.net/g/527819",
  "https://nhentai.net/g/527758",
  "https://nhentai.net/g/527681",
  "https://nhentai.net/g/527695",
  "https://nhentai.net/g/513283",
  "https://nhentai.net/g/513685",
  "https://nhentai.net/g/521537",
  "https://nhentai.net/g/527751",
  "https://nhentai.net/g/527710",
  "https://nhentai.net/g/527694",
  "https://nhentai.net/g/527732",
  "https://nhentai.net/g/527711",
  "https://nhentai.net/g/527500",
  "https://nhentai.net/g/527259",
  "https://nhentai.net/g/527560",
  "https://nhentai.net/g/527491",
  "https://nhentai.net/g/527487",
  "https://nhentai.net/g/527486",
  "https://nhentai.net/g/527300",
  "https://nhentai.net/g/526744",
  "https://nhentai.net/g/527371",
  "https://nhentai.net/g/526577",
  "https://nhentai.net/g/526583",
  "https://nhentai.net/g/526632",
  "https://nhentai.net/g/526755",
  "https://nhentai.net/g/526829",
  "https://nhentai.net/g/526936",
  "https://nhentai.net/g/526469",
  "https://nhentai.net/g/527025",
  "https://nhentai.net/g/527039",
  "https://nhentai.net/g/526813",
  "https://nhentai.net/g/526876",
  "https://nhentai.net/g/526812",
  "https://nhentai.net/g/526853",
  "https://nhentai.net/g/526898",
  "https://nhentai.net/g/526687",
  "https://nhentai.net/g/526639",
  "https://nhentai.net/g/516496",
  "https://nhentai.net/g/525051",
  "https://nhentai.net/g/390600",
  "https://nhentai.net/g/526381",
  "https://nhentai.net/g/501809",
  "https://nhentai.net/g/526144",
  "https://nhentai.net/g/526061",
  "https://nhentai.net/g/504077",
  "https://nhentai.net/g/526092",
  "https://nhentai.net/g/525880",
  "https://nhentai.net/g/525640",
  "https://nhentai.net/g/525642",
  "https://nhentai.net/g/525669",
  "https://nhentai.net/g/525684",
  "https://nhentai.net/g/525716",
  "https://nhentai.net/g/525623",
  "https://nhentai.net/g/525764",
  "https://nhentai.net/g/525768",
  "https://nhentai.net/g/525698",
  "https://nhentai.net/g/525281",
  "https://nhentai.net/g/525291",
  "https://nhentai.net/g/525293",
  "https://nhentai.net/g/525292",
  "https://nhentai.net/g/525295",
  "https://nhentai.net/g/525297",
  "https://nhentai.net/g/525285",
  "https://nhentai.net/g/524996",
  "https://nhentai.net/g/524013",
  "https://nhentai.net/g/524538",
  "https://nhentai.net/g/524815",
  "https://nhentai.net/g/524702",
  "https://nhentai.net/g/524572",
  "https://nhentai.net/g/524301",
  "https://nhentai.net/g/524300",
  "https://nhentai.net/g/524380",
  "https://nhentai.net/g/524387",
  "https://nhentai.net/g/524388",
  "https://nhentai.net/g/524391",
  "https://nhentai.net/g/524403",
  "https://nhentai.net/g/524377",
  "https://nhentai.net/g/524336",
  "https://nhentai.net/g/523492",
  "https://nhentai.net/g/523568",
  "https://nhentai.net/g/523623",
  "https://nhentai.net/g/523749",
  "https://nhentai.net/g/523759",
  "https://nhentai.net/g/523760",
  "https://nhentai.net/g/523790",
  "https://nhentai.net/g/523851",
  "https://nhentai.net/g/523885",
  "https://nhentai.net/g/523908",
  "https://nhentai.net/g/523924",
  "https://nhentai.net/g/523942",
  "https://nhentai.net/g/523901",
  "https://nhentai.net/g/523890",
  "https://nhentai.net/g/523820",
  "https://nhentai.net/g/523332",
  "https://nhentai.net/g/511038",
  "https://nhentai.net/g/523626",
  "https://nhentai.net/g/523634",
  "https://nhentai.net/g/523632",
  "https://nhentai.net/g/523765",
  "https://nhentai.net/g/523776",
  "https://nhentai.net/g/523724",
  "https://nhentai.net/g/523669",
  "https://nhentai.net/g/523702",
  "https://nhentai.net/g/523650",
  "https://nhentai.net/g/523586",
  "https://nhentai.net/g/465724",
  "https://nhentai.net/g/523269",
  "https://nhentai.net/g/523184",
  "https://nhentai.net/g/523013",
  "https://nhentai.net/g/523016",
  "https://nhentai.net/g/522643",
  "https://nhentai.net/g/523006",
  "https://nhentai.net/g/492190",
  "https://nhentai.net/g/522703",
  "https://nhentai.net/g/522706",
  "https://nhentai.net/g/522525",
  "https://nhentai.net/g/522366",
  "https://nhentai.net/g/522364",
  "https://nhentai.net/g/382186",
  "https://nhentai.net/g/522341",
  "https://nhentai.net/g/522304",
  "https://nhentai.net/g/522297",
  "https://nhentai.net/g/522232",
  "https://nhentai.net/g/522250",
  "https://nhentai.net/g/521869",
  "https://nhentai.net/g/521911",
  "https://nhentai.net/g/520880",
  "https://nhentai.net/g/520899",
  "https://nhentai.net/g/511812",
  "https://nhentai.net/g/520724",
  "https://nhentai.net/g/510676",
  "https://nhentai.net/g/520590",
  "https://nhentai.net/g/520496",
  "https://nhentai.net/g/520480",
  "https://nhentai.net/g/520605",
  "https://nhentai.net/g/520594",
  "https://nhentai.net/g/520277",
  "https://nhentai.net/g/520278",
  "https://nhentai.net/g/518795",
  "https://nhentai.net/g/520242",
  "https://nhentai.net/g/520250",
  "https://nhentai.net/g/520158",
  "https://nhentai.net/g/520120",
  "https://nhentai.net/g/520132",
  "https://nhentai.net/g/520107",
  "https://nhentai.net/g/520018",
  "https://nhentai.net/g/520114",
  "https://nhentai.net/g/520044",
  "https://nhentai.net/g/520042",
  "https://nhentai.net/g/520060",
  "https://nhentai.net/g/520040",
  "https://nhentai.net/g/519967",
  "https://nhentai.net/g/519995",
  "https://nhentai.net/g/519888",
  "https://nhentai.net/g/519924",
  "https://nhentai.net/g/519903",
  "https://nhentai.net/g/519851",
  "https://nhentai.net/g/519750",
  "https://nhentai.net/g/519811",
  "https://nhentai.net/g/519755",
  "https://nhentai.net/g/499362",
  "https://nhentai.net/g/519710",
  "https://nhentai.net/g/519675",
  "https://nhentai.net/g/512073",
  "https://nhentai.net/g/519629",
  "https://nhentai.net/g/519538",
  "https://nhentai.net/g/519532",
  "https://nhentai.net/g/519482",
  "https://nhentai.net/g/519455",
  "https://nhentai.net/g/519451",
  "https://nhentai.net/g/519387",
  "https://nhentai.net/g/519426",
  "https://nhentai.net/g/519098",
  "https://nhentai.net/g/472710",
  "https://nhentai.net/g/519372",
  "https://nhentai.net/g/519077",
  "https://nhentai.net/g/519054",
  "https://nhentai.net/g/519016",
  "https://nhentai.net/g/518937",
  "https://nhentai.net/g/518698",
  "https://nhentai.net/g/518678",
  "https://nhentai.net/g/478658",
  "https://nhentai.net/g/452916",
  "https://nhentai.net/g/459311",
  "https://nhentai.net/g/347539",
  "https://nhentai.net/g/518652",
  "https://nhentai.net/g/499144",
  "https://nhentai.net/g/501786",
  "https://nhentai.net/g/515950",
  "https://nhentai.net/g/489859",
  "https://nhentai.net/g/511607",
  "https://nhentai.net/g/518603",
  "https://nhentai.net/g/518633",
  "https://nhentai.net/g/518651",
  "https://nhentai.net/g/517530",
  "https://nhentai.net/g/517592",
  "https://nhentai.net/g/512540",
  "https://nhentai.net/g/517639",
  "https://nhentai.net/g/517650",
  "https://nhentai.net/g/517901",
  "https://nhentai.net/g/518266",
  "https://nhentai.net/g/517885",
  "https://nhentai.net/g/518328",
  "https://nhentai.net/g/518292",
  "https://nhentai.net/g/518147",
  "https://nhentai.net/g/518162",
  "https://nhentai.net/g/518140",
  "https://nhentai.net/g/517874",
  "https://nhentai.net/g/517823",
  "https://nhentai.net/g/517873",
  "https://nhentai.net/g/495790",
  "https://nhentai.net/g/517594",
  "https://nhentai.net/g/517567",
  "https://nhentai.net/g/517489",
  "https://nhentai.net/g/517485",
  "https://nhentai.net/g/517482",
  "https://nhentai.net/g/517329",
  "https://nhentai.net/g/517057",
  "https://nhentai.net/g/516982",
  "https://nhentai.net/g/516697",
  "https://nhentai.net/g/490102",
  "https://nhentai.net/g/415848",
  "https://nhentai.net/g/514151",
  "https://nhentai.net/g/508413",
  "https://nhentai.net/g/493404",
  "https://nhentai.net/g/515887",
  "https://nhentai.net/g/515738",
  "https://nhentai.net/g/515751",
  "https://nhentai.net/g/515737",
  "https://nhentai.net/g/515673",
  "https://nhentai.net/g/515660",
  "https://nhentai.net/g/515658",
  "https://nhentai.net/g/515520",
  "https://nhentai.net/g/492582",
  "https://nhentai.net/g/468049",
  "https://nhentai.net/g/373836",
  "https://nhentai.net/g/514613",
  "https://nhentai.net/g/514649",
  "https://nhentai.net/g/514790",
  "https://nhentai.net/g/514498",
  "https://nhentai.net/g/514528",
  "https://nhentai.net/g/514496",
  "https://nhentai.net/g/514468",
  "https://nhentai.net/g/514350",
  "https://nhentai.net/g/514358",
  "https://nhentai.net/g/487882",
  "https://nhentai.net/g/513961",
  "https://nhentai.net/g/513977",
  "https://nhentai.net/g/513453",
  "https://nhentai.net/g/513612",
  "https://nhentai.net/g/444310",
  "https://nhentai.net/g/506760",
  "https://nhentai.net/g/513443",
  "https://nhentai.net/g/513420",
  "https://nhentai.net/g/513439",
  "https://nhentai.net/g/513438",
  "https://nhentai.net/g/475433",
  "https://nhentai.net/g/470463",
  "https://nhentai.net/g/512558",
  "https://nhentai.net/g/512547",
  "https://nhentai.net/g/512563",
  "https://nhentai.net/g/512371",
  "https://nhentai.net/g/512300",
  "https://nhentai.net/g/512262",
  "https://nhentai.net/g/512185",
  "https://nhentai.net/g/512184",
  "https://nhentai.net/g/512216",
  "https://nhentai.net/g/486857",
  "https://nhentai.net/g/512137",
  "https://nhentai.net/g/511888",
  "https://nhentai.net/g/511979",
  "https://nhentai.net/g/511899",
  "https://nhentai.net/g/511500",
  "https://nhentai.net/g/511486",
  "https://nhentai.net/g/511504",
  "https://nhentai.net/g/511525",
  "https://nhentai.net/g/511224",
  "https://nhentai.net/g/510816",
  "https://nhentai.net/g/510898",
  "https://nhentai.net/g/475591",
  "https://nhentai.net/g/476800",
  "https://nhentai.net/g/510393",
  "https://nhentai.net/g/510392",
  "https://nhentai.net/g/510177",
  "https://nhentai.net/g/433984",
  "https://nhentai.net/g/470478",
  "https://nhentai.net/g/485729",
  "https://nhentai.net/g/494612",
  "https://nhentai.net/g/510150",
  "https://nhentai.net/g/509369",
  "https://nhentai.net/g/509340",
  "https://nhentai.net/g/508928",
  "https://nhentai.net/g/508600",
  "https://nhentai.net/g/508592",
  "https://nhentai.net/g/508450",
  "https://nhentai.net/g/508444",
  "https://nhentai.net/g/508552",
  "https://nhentai.net/g/507026",
  "https://nhentai.net/g/507891",
  "https://nhentai.net/g/507948",
  "https://nhentai.net/g/439781",
  "https://nhentai.net/g/507922",
  "https://nhentai.net/g/507659",
  "https://nhentai.net/g/507603",
  "https://nhentai.net/g/507593",
  "https://nhentai.net/g/507443",
  "https://nhentai.net/g/507280",
  "https://nhentai.net/g/507288",
  "https://nhentai.net/g/507154",
  "https://nhentai.net/g/507051",
  "https://nhentai.net/g/507217",
  "https://nhentai.net/g/506431",
  "https://nhentai.net/g/506275",
  "https://nhentai.net/g/506280",
  "https://nhentai.net/g/506270",
  "https://nhentai.net/g/506264",
  "https://nhentai.net/g/506237",
  "https://nhentai.net/g/506192",
  "https://nhentai.net/g/503771",
  "https://nhentai.net/g/477549",
  "https://nhentai.net/g/492589",
  "https://nhentai.net/g/505989",
  "https://nhentai.net/g/505835",
  "https://nhentai.net/g/505832",
  "https://nhentai.net/g/505854",
  "https://nhentai.net/g/505877",
  "https://nhentai.net/g/505656",
  "https://nhentai.net/g/505681",
  "https://nhentai.net/g/505755",
  "https://nhentai.net/g/505560",
  "https://nhentai.net/g/505613",
  "https://nhentai.net/g/505396",
  "https://nhentai.net/g/505498",
];

function delay(ms) {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

// 擷取圖片 URL 的函數
async function scrapeImagesFromUrl(url) {
  try {
    // 發送 HTTP 請求以取得 HTML
    const { data } = await axios.get(url);
    const dir = path.basename(url);

    // 使用 cheerio 解析 HTML
    const $ = cheerio.load(data);

    // 選擇所有 #thumbnail-container 裡面的 <img> 標籤
    $("#thumbnail-container .gallerythumb img").each(async (index, element) => {
      const imageUrl = $(element).attr("data-src");
      if (imageUrl) {
        const bigImageUrl = imageUrl.replace(
          /^https:\/\/t(\d)\.nhentai\.net\/galleries\/(\d+)\/(\d+)t\.jpg/i,
          "https://i$1.nhentai.net/galleries/$2/$3.jpg"
        );
        await limitFn(() => downloadImage(dir, bigImageUrl));
      }
    });
  } catch (error) {
    console.error(`Error fetching images from ${url}:`, error);
  }
}

// 建立目錄
function ensureDirectoryExistence(filePath) {
  const dirname = path.dirname(filePath);
  if (!fs.existsSync(dirname)) {
    fs.mkdirSync(dirname, { recursive: true }); // 使用 recursive 创建多层目录
  }
}

// 下載圖片
async function downloadImage(dir, url) {
  const response = await axios({
    url,
    responseType: "stream",
  });

  const fileName = path.basename(url);
  const filePath = path.join("galleries", dir, fileName);

  ensureDirectoryExistence(filePath);

  // 儲存圖片
  const writer = fs.createWriteStream(filePath);
  response.data.pipe(writer);

  // 確保正確儲存
  return new Promise((resolve, reject) => {
    writer.on("finish", () => {
      console.log(`Download ${filePath} complete.`);
      resolve(true);
    });
    writer.on("error", reject);
  });
}

// 處理所有網址
async function scrapeAllUrls() {
  for (const url of urls) {
    await scrapeImagesFromUrl(url);
    await delay(1000);
  }
}

scrapeAllUrls();
